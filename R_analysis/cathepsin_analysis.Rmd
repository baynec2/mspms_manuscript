---
title: "Analysis"
author: "Charlie Bayne"
date: "`r Sys.Date()`"
output:
  html_document:
        theme: cosmo
        toc: true
        toc_depth: 6
        toc_float:
            collapsed: true
            smooth_scroll: true
        code_folding: hide
        highlight: tango
        df_print: paged
---

```{r setup, include=FALSE}
library(tidyverse)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

# Processing 


```{r}
library(mspms)
prepared_data = prepare_peaks("../data/cathepsins/protein-peptides-lfq.csv",
                              "../data/cathepsins/protein-peptides-id.csv")


design_matrix = readr::read_csv("../data/cathepsins/design_matrix.csv")

mspms_data = mspms(prepared_data,
                   design_matrix)
```


# Figure 1 - Overview of the mspms package

## Figure 1A - Overview of Mspms package

Generated in plot.IO


## Figure 1B- Example plots?



# Figure 2 - Overall clustering of data


## Figure 2A - PCA 

```{r,fig.height = 4, fig.width =6}
fig2a = plot_pca(mspms_data)+
  viridis::scale_color_viridis(discrete = TRUE)

fig2a

ggsave(fig2a,
       filename = "../figures/Figure2_overall_clustering/A_PCA/fig2a.pdf",
       width = 6,
       height = 4)
```


## Figure 2B - unsupervised hierchical clustering of data 

```{r,fig.height = 40, fig.width = 25}
p1 = plot_heatmap(mspms_data, plot_method = "plotly")
p1
```

saved as .png using the export to png button. 

# Figure 3

## Figure 3A - Volcano Plots

```{r,fig.height = 11, fig.width =2.5}
t_tests = log2fc_t_test(mspms_data)

log2fc_threshold = 3

fig3a <- t_tests %>%
    dplyr::mutate(`log_10_p.adj` = -log10(.data$p.adj)) %>%
    ggplot2::ggplot(ggplot2::aes_string(x = "log2fc", y = "log_10_p.adj",color = "time")) +
    ggplot2::geom_point(size = 0.5) +
    ggplot2::geom_hline(
      yintercept = -log10(0.05),
      linetype = "dashed", color = "red"
    ) +
    ggplot2::geom_vline(
      xintercept = log2fc_threshold,
      linetype = "dashed", color = "red"
    ) +
    ggplot2::geom_vline(
      xintercept = -log2fc_threshold,
      linetype = "dashed", color = "red"
    ) +
    ggplot2::labs(x = "Log2 (Time TX/T0)", y = "-log10(p.adj value)") +
  facet_wrap(~condition,ncol = 1)+
  viridis::scale_color_viridis(discrete = TRUE)+
  theme(legend.position = "bottom")+
  geom_vline(xintercept = 0)

ggplot2::theme_set(ggplot2::theme_minimal())

fig3a

ggsave(fig3a,filename = "../figures/Figure3_experimental_analysis/A/fig3a.pdf",width = 2.5, height = 11)

```

## Figure 3B - Cleavage Positions 

```{r,fig.height = 11, fig.width= 2.5}
sig = t_tests %>% 
  filter(p.adj <= 0.05, log2fc >3)

d = count_cleavages_per_pos(sig)

fig3b = plot_cleavages_per_pos(d,ncol = 1)+
  viridis::scale_color_viridis(discrete = TRUE)+
  theme(legend.position = "bottom")

fig3b

ggsave("../figures/Figure3_experimental_analysis/B/fig3b.pdf",fig3b, width = 2.5, height = 11)

```



## Figure 3C - Icelogos 

```{r,fig.height = 11,fig.width = 3.5}
fig3c = plot_all_icelogos(mspms_data)

fig3c

ggsave("../figures/Figure3_experimental_analysis/C/fig3c.pdf",fig3c, width = 3.5, height = 11)


```

# Supplementary Figures 


## Figure S1 - QC checks

### A - Full length peptide library detected at T0

```{r,fig.height = 5.5, fig.width = 4}

qc_check = qc_check(prepared_data,
                    peptide_library = mspms::peptide_library,
                    design_matrix)


t0_qc = dplyr::filter(qc_check, time == 0)


S1a = plot_qc_check(t0_qc,ncol = 1)[[1]]+
  xlim(c(90,100))

ggsave("../figures/Supplementary/S1_qc_checks/S1a.pdf",S1a,width = 4,
       height = 5.5)

```
### B All Peptides in library

```{r, fig.height = 5.5, fig.width = 4}
S1b = plot_qc_check(qc_check,thresold_percent = 95,ncol = 3)[[2]]+
  xlim(c(93,100))

S1b

ggsave("../figures/Supplementary/S1_qc_checks/S1b.pdf",S1b,width = 4,
       height = 5.5)

```

```{r,fig.height = 5.5, fig.width = 8}
nd_peptides = find_nd_peptides(prepared_data,
                               mspms::peptide_library,
                               design_matrix)

S1c = plot_nd_peptides(nd_peptides)

S1c

ggsave("../figures/Supplementary/S1_qc_checks/S1c.pdf",S1c,width = 8,
       height = 5.5)
```
## Figure S2 - Gradient Evaluation


```{r}
lc_params = data.frame(time = c(0,60,65,75,85,95),
                            per_B = c(5,30,85,90,1,1))


S2 = plot_rt_qc(prepared_data,design_matrix,
                      facet_by_group = FALSE,
                      type = "histogram",
                      binwidth = 1)+
    # Custom the Y scales:
  scale_y_continuous(
    # Features of the first axis
    name = "Peptide Count",
    # Add a second axis and specify its features
    sec.axis = sec_axis( trans = ~ . /15, name="Percent Solvent B")
  )+
    geom_line(data = lc_params,aes(x = time, y = per_B*15),
            color = "red",
            linetype = "dashed")
S2

ggsave("../figures/Supplementary/S2_retention_time_checks/S2.pdf",S2,width = 5, height = 4)
```

## Figure S3 - Number of signficant peptides per incubation time.

```{r,fig.height =4, fig.width = 5}

sum = sig %>% 
  group_by(condition,time) %>% 
  summarise(n = n())

S3 = sum %>% 
  ggplot(aes(time,n,color = condition))+
  geom_point()+
  geom_line(aes(group = condition))+
  viridis::scale_color_viridis(discrete = TRUE)+
  theme(legend.position = "bottom")+
  xlab("Time (minutes)")+
  ylab("Number of Peptides")+
  ylim(0,120)

S3

ggsave("../figures/Supplementary/S3_sig_peptides_over_time/S3.pdf",S3,width = 5, height = 4)


```

## Figure S4- querying described cat C rules

negative enrichment of proline at P1 or P1â€™, or lysine and arginine at  N-terminal residues. 

### A  
```{r,fig.height = 4, fig.width = 5}


## Checking to see if cleavages that fit the described catC rules are enriched in the data.
fits_rules = mspms_data %>% 
  filter(condition == "CatC") %>% 
  filter(grepl("XX[^R|K|X][^P][^P]...",cleavage_seq)) %>% 
  filter(time %in% c(0,90)) %>% 
  dplyr::group_by(Peptide,time,cleavage_seq) %>% 
  summarise(mean = mean(value,na.rm = T)) %>% 
  mutate(time = as.factor(time)) %>% 
  ungroup()


t.test = rstatix::t_test(mean ~ time,data = fits_rules) %>% 
  rstatix::add_y_position() %>% 
  rstatix::add_significance() %>% 
  mutate(y.position = log10(y.position))


S4a = fits_rules %>% 
  ggplot(aes(x = time,y = mean))+
  geom_violin()+
  geom_point()+
  geom_line(aes(group = Peptide),stat = "summary",fun = mean,alpha = 0.3)+
  ggpubr::stat_pvalue_manual(t.test,label = "p.signif")+
  scale_y_log10()+
  xlab("Time (minutes)")

S4a

```

## B
```{r,fig.height = 4, fig.width = 5}


## Checking to see if cleavages that fit the described catC rules are enriched in the data.
fits_rules = mspms_data %>% 
  filter(condition == "CatC") %>% 
  filter(grepl("XX[R|K].....",cleavage_seq)) %>% 
  filter(time %in% c(0,90)) %>% 
  dplyr::group_by(Peptide,time,cleavage_seq) %>% 
  summarise(mean = mean(value,na.rm = T)) %>% 
  mutate(time = as.factor(time)) %>% 
  ungroup()


t.test = rstatix::t_test(mean ~ time,data = fits_rules) %>% 
  rstatix::add_y_position() %>% 
  rstatix::add_significance() %>% 
  mutate(y.position = log10(y.position))


S4b = fits_rules %>% 
  ggplot(aes(x = time,y = mean))+
  geom_violin()+
  geom_point()+
  geom_line(aes(group = Peptide),stat = "summary",fun = mean,alpha = 0.3)+
  ggpubr::stat_pvalue_manual(t.test,label = "p.signif")+
  scale_y_log10()+
  xlab("Time (minutes)")

S4b

```

## C

```{r,fig.height = 4, fig.width = 5}


## Checking to see if cleavages that fit the described catC rules are enriched in the data.
fits_rules = mspms_data %>% 
  filter(condition == "CatC") %>% 
  filter(grepl("XX.[P]....",cleavage_seq)) %>% 
  filter(time %in% c(0,90)) %>% 
  dplyr::group_by(Peptide,time,cleavage_seq) %>% 
  summarise(mean = mean(value,na.rm = T)) %>% 
  mutate(time = as.factor(time)) %>% 
  ungroup()


t.test = rstatix::t_test(mean ~ time,data = fits_rules) %>% 
  rstatix::add_y_position() %>% 
  rstatix::add_significance() %>% 
  mutate(y.position = log10(y.position))


S4c = fits_rules %>% 
  ggplot(aes(x = time,y = mean))+
  geom_violin()+
  geom_point()+
  geom_line(aes(group = Peptide),stat = "summary",fun = mean,alpha = 0.3)+
  ggpubr::stat_pvalue_manual(t.test,label = "p.signif")+
  scale_y_log10()+
  xlab("Time (minutes)")

S4c

```

## D 
```{r,fig.height = 4, fig.width = 5}


## Checking to see if cleavages that fit the described catC rules are enriched in the data.
fits_rules = mspms_data %>% 
  filter(condition == "CatC") %>% 
  filter(grepl("XX..[P]...",cleavage_seq)) %>% 
  filter(time %in% c(0,90)) %>% 
  dplyr::group_by(Peptide,time,cleavage_seq) %>% 
  summarise(mean = mean(value,na.rm = T)) %>% 
  mutate(time = as.factor(time)) %>% 
  ungroup()


t.test = rstatix::t_test(mean ~ time,data = fits_rules) %>% 
  rstatix::add_y_position() %>% 
  rstatix::add_significance() %>% 
  mutate(y.position = log10(y.position))


S4d  = fits_rules %>% 
  ggplot(aes(x = time,y = mean))+
  geom_violin()+
  geom_point()+
  geom_line(aes(group = Peptide),stat = "summary",fun = mean,alpha = 0.3)+
  ggpubr::stat_pvalue_manual(t.test,label = "p.signif")+
  scale_y_log10()+
  xlab("Time (minutes)")

S4d

```

### E

```{r,fig.height = 4, fig.width = 5}
## Reversing the rules in reverse to see if we see enrichment (we expect not to.) ##

fits_rules = mspms_data %>% 
  filter(condition == "CatC") %>% 
  filter(grepl("...[^P][^P][^R|K|X]XX",cleavage_seq)) %>% 
  filter(time %in% c(0,90)) %>% 
  dplyr::group_by(Peptide,time) %>% 
  summarise(mean = mean(value,na.rm = T)) %>% 
  mutate(time = as.factor(time)) %>% 
  ungroup()


t.test = rstatix::t_test(mean ~ time,data = fits_rules) %>% 
  rstatix::add_y_position() %>% 
  rstatix::add_significance() %>% 
  mutate(y.position = log10(y.position))


S4e = fits_rules %>% 
  ggplot(aes(x = time,y = mean))+
  geom_violin()+
  geom_point()+
  geom_line(aes(group = Peptide),stat = "summary",fun = mean,alpha = 0.3)+
  ggpubr::stat_pvalue_manual(t.test,label = "p.signif")+
  scale_y_log10()+
  xlab("Time (minutes)")

S4e

```

```{r,fig.height = 4, fig.width = 5}
## Reversing the rules in reverse to see if we see enrichment (we expect not to.) ##

fits_rules = mspms_data %>% 
  filter(condition == "CatC") %>% 
  filter(!is.na(cleavage_seq)) %>% 
  filter(time %in% c(0,90)) %>% 
  dplyr::group_by(Peptide,time) %>% 
  summarise(mean = mean(value,na.rm = T)) %>% 
  mutate(time = as.factor(time)) %>% 
  ungroup()


t.test = rstatix::t_test(mean ~ time,data = fits_rules) %>% 
  rstatix::add_y_position() %>% 
  rstatix::add_significance() %>% 
  mutate(y.position = log10(y.position))


S4f = fits_rules %>% 
  ggplot(aes(x = time,y = mean))+
  geom_violin()+
  geom_point()+
  geom_line(aes(group = Peptide),stat = "summary",fun = mean,alpha = 0.3)+
  ggpubr::stat_pvalue_manual(t.test,label = "p.signif")+
  scale_y_log10()+
  xlab("Time (minutes)")

S4f

```




```{r,fig.height = 6, fig.width = 10}

S4 = ggpubr::ggarrange(S4a, S4b, S4c, S4d, S4e, S4f, labels = c("A","B","C","D","E","F"))

S4

ggsave("../figures/Supplementary/S4_catC_additional_analysis/S4.pdf",S4, height = 6, width = 10)
```


## Figure S5 - Longer motif analysis 

```{r,,fig.height = 11,fig.width = 6}
# Running mspms with 6 residues to the left and right of the cleavage site reported
mspms_data_6 = mspms::mspms(prepared_data,
                          design_matrix,
                          n_residues = 6)


# Calculating all possible cleavages 6 AAs to the left and right of the cleavage
# site.
cleavage_6 = mspms::calculate_all_cleavages(mspms::peptide_library$library_real_sequence,6)



S5 = plot_all_icelogos(mspms_data_6,
                       background_universe = cleavage_6)

S5


ggsave("../figures/Supplementary/S5_longer_motif_analysis/S5.pdf",S5, height = 11,
       width =6)

```




